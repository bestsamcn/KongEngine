# Real-Time Volumetric Rendering学习记录
[文章链接]("https://patapom.com/topics/Revision2013/Revision%202013%20-%20Real-time%20Volumetric%20Rendering%20Course%20Notes.pdf")

https://patapom.com/topics/Revision2013/Revision%202013%20-%20Real-time%20Volumetric%20Rendering%20Course%20Notes.pdf

https://zhuanlan.zhihu.com/p/36498679

## 单次散射模型
光进入大气层，经过一次散射后进入观察者眼中。第一次散射的能量最高，后面散射的光线能量较低。
假设散射的点为P，位于观察方向上，大气入射点为A，观察者点位O。
则光线经过PA路径上发生了衰减，在P点进行散射后，在OP路径上进行衰减传入观察者眼中。

因此我们需要计算的是，光线在进入大气后经过*PA的衰减（光学距离）*，P点散射后*传入观察者方向的比例（相位函数）*，以及*OP路径上光线的衰减（光学距离）*。

另外P点只是观察方向上的一个点，需要针对观察方向上（P1,P2,...Pn）的大气中（大气外的不会发生折射）的所有点进行采样并将结果累加。

## 参与性介质
participating medium是一种体积（介质），它的折射率、反射率、密度等等会局部发生变化。
所有的介质在某种程度上都是参与性介质，取决于考虑的尺度。有些介质在较短的尺度上可以定义为同性质的，大部分情况要考虑不同性质的介质的属性变化。

当一束光子流（光照）接入参与性介质的时候，会发生：
- 吸收：和波长相关，不同波长的吸收率是不一样的。比如天空和大海的颜色是蓝色是因为其波长最短
- 散射：光子碰撞到介质中的微小颗粒弹开，形成散射。和介质的密度相关，大部分发生是随机的。
  - 散射也包括外散射和内散射。外散射是这一束光子流的光子弹开，减弱光子流的能量；内散射是其他光子流的光子散射到当前光子流的路径上， 增强光子流的能量。

计算光穿越参与性介质区域表现就是计算概率。

## 消光函数：比尔-朗伯定律
[Extinction Function(Beer-Lambert law)](https://zh.wikipedia.org/wiki/%E6%AF%94%E5%B0%94-%E6%9C%97%E4%BC%AF%E5%AE%9A%E5%BE%8B)。用于表示沿路径穿过介质一定距离没有击中一个介质中的粒子的概率（不发生散射或者吸收现象），也可以代表了介质的透明度。


## 相函数
具体函数在文章中可见。
它描述的是在所有散射的方向中，某个方向所占的比例。
### Rayleigh Phase Function
**瑞利散射**：一种光的散射现象，当光线通过介质中的微小颗粒或分子时，由于颗粒或分子的尺寸远小于光的波长，光线会以不同的角度散射。瑞利散射主要发生在大气中，导致天空呈现蓝色。

### Henyey-Greenstein Phase Function/Schlick phase function
**米氏散射**：考虑介质中包含大颗粒，如气溶胶、灰尘、水滴等等，会出现米氏散射。

消光函数只能用于单次散射事件，也就是光从粒子上反弹一次。多次散射事件非常昂贵，需要依靠近似方法来实现。

由于函数的内散射部分，按照真实世界的规律的话是需要考虑来自所有方向的光源，也就是需要积分计算影响这次散射的所有光的能量，这种计算是递归的，如此一来多次散射的耗时是极大的。

### 光学深度
optical depth，是代表了光线用A点到B点所积累的消光系数，乘以A点到B点的路径长度。它表示光在传输路径上被散射或者吸收的比例。


### 近似方法
将光源简化为三个：
- 来自太阳的直射光
- 来自太阳的间接光
- 来自天空的间接光

计算光照的时候会是将整个光线传播路径分成小段，沿着小段逐步累加
消光函数部分也简化为是前面每一小段的结果的乘积的累加。
所以最终每一小段需要计算的，是积累到当前小段的透明度（消光度），乘以当前小段的散射概率，乘以三个光源的强度的积分